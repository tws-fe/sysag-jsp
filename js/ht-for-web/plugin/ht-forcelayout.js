!function(H,L){"use strict";var W="ht",B=W+".layout.",l=H[W]||module.parent.exports.ht,z=l.List,u=l.DataModel,K=l.Node,d=l.Edge,a=l.Group,w=Math,v=w.sqrt,J=w.random,i=w.max,Z=w.min,M=function(m){return m*m};l.Default.getInternal().addMSMap({ms_force:function($){$._interval=50,$._stepCount=10,$._motionLimit=.01,$._edgeRepulsion=.65,$._nodeRepulsion=.65,$._damper=1,$._maxMotion=0,$._motionRatio=0,$.init=function(b){var X=this;b instanceof u?X.dm=b:X.gv=b,X._nodeMap={},X._nodes=new z,X._edges=new z},$.start=function(){var n=this,j=n.gv;if(!n._timer){var z=n.cdm=j?j.dm():n.dm;z.mm(n.handleDataModelChange,n),z.md(n.handleDataPropertyChange,n),j&&j.mp(n.handleGV,n),z.each(function(q){if(n.isVisible(q)&&n.isLayoutable(q)&&q instanceof K)if(n instanceof N){var U=q.p3();q.p3([U[0]+J(),U[1]+J(),U[2]+J()])}else U=q.p(),q.p(U.x+J(),U.y+J())}),n._timer=setInterval(function(){n.relax()},n._interval),n._damper=1}},$.stop=function(){var n=this;n._timer&&(n.cdm.umm(n.handleDataModelChange,n),n.cdm.umd(n.handleDataPropertyChange,n),n.gv&&n.gv.ump(n.handleGV,n),clearInterval(n._timer),delete n._timer,delete n.cdm)},$.handleGV=function(b){var H=this;if("dataModel"===b.property){var m=b.oldValue,I=b.newValue;m&&(m.umm(H.handleDataModelChange,H),m.umd(H.handleDataPropertyChange,H)),this.cdm=I,I.mm(H.handleDataModelChange,H),I.md(H.handleDataPropertyChange,H)}},$.relax=function(){var G=this;if(!(G._damper<.1&&G._maxMotion<G._motionLimit)){this.cdm.each(function(F){G.isVisible(F)&&(F instanceof d?G.addEdge(F):F instanceof K&&G.addNode(F))});for(var L,c,$=0,F=G._edges,S=G._nodes,o=S.size();$<G._stepCount;$++){for(F.each(G.relaxEdge,G),L=0;o>L;L++)for(c=0;o>c;c++)G.relaxNode(S.get(L),S.get(c));G.moveNode()}G._isAdjusting=1,S.each(function(w){w.fix||(w.p?w.v.p3(w.p):w.v.p(w.x,w.y))}),delete G._isAdjusting,G._nodeMap={},S.clear(),F.clear(),G.onRelaxed()}},$.onRelaxed=function(){},$.isRunning=function(){return!!this._timer},$.isVisible=function(J){return J.s("layoutable")===!1?!1:this.gv?this.gv.isVisible(J):!0},$.isLayoutable=function(C){if(C.s("layoutable")===!1)return!1;if(C instanceof a)return!1;var E=this;return E.gv?E.gv.isMovable(C)&&!E.gv.isSelected(C):!(E.cdm||E.dm).sm().co(C)},$.getNodeRepulsion=function(){return this._nodeRepulsion},$.setNodeRepulsion=function(d){this._nodeRepulsion=d,this._damper=1},$.getEdgeRepulsion=function(){return this._edgeRepulsion},$.setEdgeRepulsion=function(E){this._edgeRepulsion=E,this._damper=1},$.getStepCount=function(){return this._stepCount},$.setStepCount=function(m){this._stepCount=m,this._damper=1},$.getInterval=function(){return this._interval},$.setInterval=function(n){var G=this;G._interval!==n&&(G._interval=n,G._timer&&(clearInterval(G._timer),G._timer=setInterval(function(){G.relax()},n)))},$.handleDataPropertyChange=function(Y){!this._isAdjusting&&this.isVisible(Y.data)&&(this._damper=1)},$.handleDataModelChange=function(){this._damper=1},$.damp=function(){var x=this._maxMotion,z=this._damper;this._motionRatio<=.001&&((.2>x||x>1&&.9>z)&&z>.01?this._damper-=.01:.4>x&&z>.003?this._damper-=.003:z>1e-4&&(this._damper-=1e-4)),x<this._motionLimit&&(this._damper=0)}}}),l.layout.ForceLayout=function(M){this.init(M)},l.Default.def(B+"ForceLayout",L,{ms_force:1,getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(f){this._limitBounds=f,this._damper=1},getNodeSize:function(g){var X=this.gv;return X&&X.getDataUIBounds?X.getDataUIBounds(g):g.getRect()},addNode:function(g){var c=this,U=c._nodeMap[g._id];if(U)return U;var w=g.p();U={v:g,x:w.x,y:w.y,dx:0,dy:0,fix:!c.isLayoutable(g),s:c.getNodeSize(g)};var x=U.s,e=v(M(x.width)+M(x.height))*c._nodeRepulsion;return U.r=1>e?100:e,c._nodeMap[g._id]=U,c._nodes.add(U),U},addEdge:function(W){if(W._40I&&W._41I){var g=this,d=g.addNode(W._40I),r=g.addNode(W._41I),S={s:d,t:r};r=r.s,d=d.s;var V=r.width+d.width,Y=r.height+d.height;S.length=v(V*V+Y*Y)*g._edgeRepulsion,S.length<=0&&(S.length=100),g._edges.add(S)}},relaxEdge:function(H){var T=H.t,l=H.s,O=T.x-l.x,Y=T.y-l.y,P=v(O*O+Y*Y),k=100*H.length,y=.25*O/k*P,w=.25*Y/k*P;T.dx=T.dx-y,T.dy=T.dy-w,l.dx=l.dx+y,l.dy=l.dy+w},relaxNode:function(Q,m){if(Q!==m){var v=0,o=0,C=Q.x-m.x,j=Q.y-m.y,R=C*C+j*j;0===R?(v=J(),o=J()):36e4>R&&(v=C/R,o=j/R);var g=Q.r*m.r/400;v*=g,o*=g,Q.dx+=v,Q.dy+=o,m.dx-=v,m.dy-=o}},moveNode:function(){var m=this,w=m._limitBounds,a=m._maxMotion,f=0,y=m._damper;m._nodes.each(function(B){if(!B.fix){var D=B.dx*y,p=B.dy*y;if(B.dx=D/2,B.dy=p/2,f=i(v(D*D+p*p),f),B.x+=i(-40,Z(40,D)),B.y+=i(-40,Z(40,p)),w){B.x<w.x&&(B.x=w.x,m.adjust(1,0)),B.y<w.y&&(B.y=w.y,m.adjust(0,1));var o=B.s;B.x+o.width>w.x+w.width&&(B.x=w.x+w.width-o.width,m.adjust(-1,0)),B.y+o.height>w.y+w.height&&(B.y=w.y+w.height-o.height,m.adjust(0,-1))}}}),m._maxMotion=f,m._motionRatio=f>0?a/f-1:0,m.damp()},adjust:function(n,R){var j=this._limitBounds;this._nodes.each(function(d){n>0?(!j||d.x+d.s.width+n<j.x+j.width)&&(d.x+=n):(!j||d.x+n>j.x)&&(d.x+=n),R>0?(!j||d.y+d.s.height+R<j.y+j.height)&&(d.y+=R):(!j||d.y+R>j.y)&&(d.y+=R)})}});var N=l.layout.Force3dLayout=function(H){this.init(H)};l.Default.def(B+"Force3dLayout",L,{ms_force:1,getNodeSize3d:function(N){return N.s3()},addNode:function(I){var v=this,e=v._nodeMap[I._id];if(e)return e;e={v:I,p:I.p3(),d:[0,0,0],fix:!v.isLayoutable(I),s:v.getNodeSize3d(I)};var Y=e.s,s=l.Default.getDistance(Y)*v._nodeRepulsion;return e.r=1>s?100:s,v._nodeMap[I._id]=e,v._nodes.add(e),e},addEdge:function(m){if(m._40I&&m._41I){var L=this,w=L.addNode(m._40I),i=L.addNode(m._41I),t={s:w,t:i};i=i.s,w=w.s,t.length=v(M(i[0]+w[0])+M(i[1]+w[1])+M(i[2]+w[2]))*L._edgeRepulsion,t.length<=0&&(t.length=100),L._edges.add(t)}},relaxEdge:function(V){var i=V.t.p,a=V.s.p,c=V.t.d,M=V.s.d,g=i[0]-a[0],k=i[1]-a[1],K=i[2]-a[2],m=v(g*g+k*k+K*K),w=100*V.length,_=.25*g/w*m,q=.25*k/w*m,I=.25*K/w*m;c[0]-=_,c[1]-=q,c[2]-=I,M[0]+=_,M[1]+=q,M[2]+=I},relaxNode:function(M,b){if(M!==b){var H=M.p,s=b.p,q=0,F=0,N=0,h=H[0]-s[0],c=H[1]-s[1],y=H[2]-s[2],B=h*h+c*c+y*y;0===B?(q=J(),F=J(),N=J()):216e6>B&&(q=h/B,F=c/B,N=y/B);var n=M.r*b.r/400,X=M.d,e=b.d;q*=n,F*=n,N*=n,X[0]+=q,X[1]+=F,X[2]+=N,e[0]-=q,e[1]-=F,e[2]-=N}},moveNode:function(){var r=this,w=r._maxMotion,Q=0,e=r._damper;r._nodes.each(function(D){if(!D.fix){var n=D.p,p=D.d,r=p[0]*e,M=p[1]*e,W=p[2]*e;p[0]=r/2,p[1]=M/2,p[2]=W/2,Q=i(v(r*r+M*M+W*W),Q),n[0]+=i(-40,Z(40,r)),n[1]+=i(-40,Z(40,M)),n[2]+=i(-40,Z(40,W))}}),r._maxMotion=Q,r._motionRatio=Q>0?w/Q-1:0,r.damp()}})}(this,Object);